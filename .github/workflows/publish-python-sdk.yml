name: Publish Python SDK

on:
  push:
    branches:
      - main
    paths:
      - 'python-sdk/**'
      - '.github/workflows/publish-python-sdk.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Generate CalVer version
        id: version
        run: |
          VERSION=$(date -u +'%Y%m%d.%H.%M')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Update version in pyproject.toml
        run: |
          python << 'EOF'
          import re
          version = "${{ steps.version.outputs.version }}"
          
          with open('python-sdk/pyproject.toml', 'r') as f:
              content = f.read()
          
          # Replace version in pyproject.toml
          updated_content = re.sub(
              r'version\s*=\s*"[^"]+"',
              f'version = "{version}"',
              content
          )
          
          with open('python-sdk/pyproject.toml', 'w') as f:
              f.write(updated_content)
          
          print(f"Updated pyproject.toml with version: {version}")
          EOF

      - name: Build distribution
        run: |
          cd python-sdk
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd python-sdk
          python -m twine upload dist/* --non-interactive

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: python-sdk-v${{ steps.version.outputs.version }}
          release_name: Python SDK Release - ${{ steps.version.outputs.version }}
          body: |
            # Python SDK Release
            
            **Version:** ${{ steps.version.outputs.version }}
            
            Published to PyPI as `prompty-sdk==${{ steps.version.outputs.version }}`
            
            Changes in `python-sdk/` directory committed on ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false

      - name: Commit version update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add python-sdk/pyproject.toml
          git commit -m "chore: bump python-sdk version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
